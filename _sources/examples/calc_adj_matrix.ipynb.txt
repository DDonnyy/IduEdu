{
 "cells": [
  {
   "metadata": {},
   "cell_type": "markdown",
   "source": "# Adjacency matrix\n",
   "id": "6bc73e0b37c4892d"
  },
  {
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-10-07T14:28:12.614461Z",
     "start_time": "2025-10-07T14:28:12.610476Z"
    }
   },
   "cell_type": "code",
   "source": "# !pip install iduedu",
   "id": "a7df97d02da184d0",
   "outputs": [],
   "execution_count": 1
  },
  {
   "cell_type": "code",
   "id": "initial_id",
   "metadata": {
    "collapsed": true,
    "ExecuteTime": {
     "end_time": "2025-10-07T14:28:12.638259Z",
     "start_time": "2025-10-07T14:28:12.616977Z"
    }
   },
   "source": [
    "# To read .parquet\n",
    "# !pip install pyarrow"
   ],
   "outputs": [],
   "execution_count": 2
  },
  {
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-10-07T14:28:13.303085Z",
     "start_time": "2025-10-07T14:28:12.642481Z"
    }
   },
   "cell_type": "code",
   "source": [
    "import geopandas as gpd\n",
    "\n",
    "# Read a GeoDataFrame, for example this one\n",
    "data = gpd.read_parquet('data/spb_buildings.parquet')\n",
    "\n",
    "# Create a polygon that encircles all the buildings in the dataset to download the graph\n",
    "polygon = data.to_crs(4326).union_all().convex_hull.buffer(0.001)"
   ],
   "id": "b647132622a4e56",
   "outputs": [],
   "execution_count": 3
  },
  {
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-10-07T14:54:33.156313Z",
     "start_time": "2025-10-07T14:52:59.698226Z"
    }
   },
   "cell_type": "code",
   "source": [
    "from iduedu import get_intermodal_graph, get_drive_graph, get_walk_graph\n",
    "\n",
    "# Download the intermodal graph\n",
    "G_intermodal = get_intermodal_graph(territory=polygon)\n",
    "\n",
    "# Uncomment the following lines to download walking or driving graphs for the same area\n",
    "# G_walk = get_walk_graph(polygon =polygon)\n",
    "# G_drive = get_drive_graph(polygon =polygon)"
   ],
   "id": "49e466e10ff48ddb",
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2025-10-07 17:52:59.701 | INFO     | Downloading walk network via Overpass ...\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "Downloading public transport routes from OSM:   0%|          | 0/4 [00:00<?, ?it/s]"
      ],
      "application/vnd.jupyter.widget-view+json": {
       "version_major": 2,
       "version_minor": 0,
       "model_id": "bd3d36bb05314550864b5cd255cfcc7a"
      }
     },
     "metadata": {},
     "output_type": "display_data",
     "jetTransient": {
      "display_id": null
     }
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2025-10-07 17:53:11.770 | WARNING  | Graph contains 58 weakly connected components. This means the graph has disconnected groups if edge directions are ignored. Component sizes:: [4235, 19, 9, 7, 5, …]\n",
      "2025-10-07 17:53:11.782 | WARNING  | Removing 164 nodes from 57 smaller strongly connected components. These are subgraphs where nodes are internally reachable but isolated from the rest. Retaining only the largest strongly connected component (4235 nodes).\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "Parsing public transport routes:   0%|          | 0/53 [00:00<?, ?it/s]"
      ],
      "application/vnd.jupyter.widget-view+json": {
       "version_major": 2,
       "version_minor": 0,
       "model_id": "9c6c6afa900d4ff1a0e3a3cc6845d2ee"
      }
     },
     "metadata": {},
     "output_type": "display_data",
     "jetTransient": {
      "display_id": null
     }
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "2025-10-07 17:54:32.280 | INFO     | Composing intermodal graph...\n",
      "2025-10-07 17:54:33.021 | WARNING  | Removing 746 nodes from 359 smaller strongly connected components. These are subgraphs where nodes are internally reachable but isolated from the rest. Retaining only the largest strongly connected component (6062 nodes).\n"
     ]
    }
   ],
   "execution_count": 7
  },
  {
   "metadata": {
    "ExecuteTime": {
     "end_time": "2025-10-07T14:30:36.260363Z",
     "start_time": "2025-10-07T14:30:34.574358Z"
    }
   },
   "cell_type": "code",
   "source": [
    "import numpy as np\n",
    "from iduedu import get_adj_matrix_gdf_to_gdf\n",
    "\n",
    "# Compute the adjacency matrix between the objects in the dataset using the intermodal graph.\n",
    "# The weight of the edges is set to 'time_min' (travel time in minutes), and the data type is set to np.float32 for precision.\n",
    "matrix = get_adj_matrix_gdf_to_gdf(data, data, G_intermodal, weight='time_min', dtype=np.float32)\n",
    "\n",
    "# Uncomment the following lines to compute adjacency matrices using driving or walking graphs with different weights and data types\n",
    "# matrix = get_adj_matrix_gdf_to_gdf(data,data,G_drive,weight='time_min',dtype=np.float16) # Use dtype >np.float16 for more precision\n",
    "# matrix = get_adj_matrix_gdf_to_gdf(data,data,G_walk,weight='length_meter',dtype=np.float16) # Use dtype >np.float16 for more precision\n",
    "matrix"
   ],
   "id": "e6005ba0235efb9d",
   "outputs": [
    {
     "data": {
      "text/plain": [
       "           0          1          2          3          4          5     \\\n",
       "0      0.000000  19.477707  21.257921  19.482340  24.370579  22.620644   \n",
       "1     16.907707   0.000000  10.998884   6.203304  13.171542  11.171609   \n",
       "2     19.997921  10.858885   0.000000   6.273519  11.051758  14.601824   \n",
       "3     15.502339   6.203304   6.273519   0.000000   9.506178  10.106242   \n",
       "4     20.190578  11.051542  10.141758   8.366178   0.000000  14.794482   \n",
       "...         ...        ...        ...        ...        ...        ...   \n",
       "1253  26.107365  16.968328  13.988544  14.282963  14.861201  20.711267   \n",
       "1254  18.705038   9.566002   8.396217   6.880637   9.608875  13.308942   \n",
       "1255  16.365540   7.226502   9.786717   4.541137  10.339375  10.969441   \n",
       "1256  16.715014   7.575979   6.406193   4.890613   7.088852  11.318917   \n",
       "1257  19.041740   9.902705  10.982920   7.217339   8.495578  13.645644   \n",
       "\n",
       "           6          7          8          9     ...       1248       1249  \\\n",
       "0     48.959641  21.764475  22.554434  19.405178  ...  23.824213  14.421368   \n",
       "1     39.310604  12.825438  12.905397   8.206142  ...  12.375177   7.542331   \n",
       "2     41.960819  16.255653  15.805614   6.086357  ...  15.805391  10.632546   \n",
       "3     37.715240  11.760073  11.310033   4.540777  ...  11.309811   6.136965   \n",
       "4     41.133480  16.448311  15.678271   7.159016  ...  15.998051  10.825205   \n",
       "...         ...        ...        ...        ...  ...        ...        ...   \n",
       "1253  47.690262  22.365097  21.915058  12.675801  ...  21.914837  16.741991   \n",
       "1254  39.317940  14.962771  13.862731   4.503475  ...  14.512510   9.339664   \n",
       "1255  36.278435  12.623271  10.293231   5.713975  ...  12.173010   7.000164   \n",
       "1256  36.487911  12.972747  11.032707   2.513451  ...  12.522487   7.349640   \n",
       "1257  39.314640  15.299474  14.849434   7.040178  ...  14.849213   9.676366   \n",
       "\n",
       "           1250       1251       1252       1253       1254       1255  \\\n",
       "0     20.024340  20.100258  20.032118  27.937365  22.015039  20.085539   \n",
       "1      9.765304   9.151222  10.383081  16.738329  10.816002   8.606503   \n",
       "2      2.645518  12.581437  13.283297  13.978543   8.396217  10.486717   \n",
       "3      7.119937   8.085856   8.787716  13.072963   7.150637   5.531137   \n",
       "4     12.278176  12.774096  12.405954  15.361201   7.818875   9.999375   \n",
       "...         ...        ...        ...        ...        ...        ...   \n",
       "1253  13.424962  18.690882  19.232740   0.000000  11.675661  16.596161   \n",
       "1254   9.032636  11.288555  10.590414  11.675661   0.000000   8.183835   \n",
       "1255  10.853136   8.949056   7.350914  14.916162   7.613835   0.000000   \n",
       "1256   8.542612   9.298532   7.760390  12.485638   3.173311   5.353811   \n",
       "1257  13.119339  11.625257  12.327117  15.462364   7.890038   9.530538   \n",
       "\n",
       "           1256       1257  \n",
       "0     19.885014  22.431742  \n",
       "1      8.685979  11.232705  \n",
       "2      6.406193   9.602920  \n",
       "3      5.020613   7.567339  \n",
       "4      4.988852   8.575578  \n",
       "...         ...        ...  \n",
       "1253  11.815638  14.892365  \n",
       "1254   3.173311   7.360038  \n",
       "1255   5.483811   8.510538  \n",
       "1256   0.000000   5.230014  \n",
       "1257   5.060014   0.000000  \n",
       "\n",
       "[1258 rows x 1258 columns]"
      ],
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>0</th>\n",
       "      <th>1</th>\n",
       "      <th>2</th>\n",
       "      <th>3</th>\n",
       "      <th>4</th>\n",
       "      <th>5</th>\n",
       "      <th>6</th>\n",
       "      <th>7</th>\n",
       "      <th>8</th>\n",
       "      <th>9</th>\n",
       "      <th>...</th>\n",
       "      <th>1248</th>\n",
       "      <th>1249</th>\n",
       "      <th>1250</th>\n",
       "      <th>1251</th>\n",
       "      <th>1252</th>\n",
       "      <th>1253</th>\n",
       "      <th>1254</th>\n",
       "      <th>1255</th>\n",
       "      <th>1256</th>\n",
       "      <th>1257</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>0.000000</td>\n",
       "      <td>19.477707</td>\n",
       "      <td>21.257921</td>\n",
       "      <td>19.482340</td>\n",
       "      <td>24.370579</td>\n",
       "      <td>22.620644</td>\n",
       "      <td>48.959641</td>\n",
       "      <td>21.764475</td>\n",
       "      <td>22.554434</td>\n",
       "      <td>19.405178</td>\n",
       "      <td>...</td>\n",
       "      <td>23.824213</td>\n",
       "      <td>14.421368</td>\n",
       "      <td>20.024340</td>\n",
       "      <td>20.100258</td>\n",
       "      <td>20.032118</td>\n",
       "      <td>27.937365</td>\n",
       "      <td>22.015039</td>\n",
       "      <td>20.085539</td>\n",
       "      <td>19.885014</td>\n",
       "      <td>22.431742</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>16.907707</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>10.998884</td>\n",
       "      <td>6.203304</td>\n",
       "      <td>13.171542</td>\n",
       "      <td>11.171609</td>\n",
       "      <td>39.310604</td>\n",
       "      <td>12.825438</td>\n",
       "      <td>12.905397</td>\n",
       "      <td>8.206142</td>\n",
       "      <td>...</td>\n",
       "      <td>12.375177</td>\n",
       "      <td>7.542331</td>\n",
       "      <td>9.765304</td>\n",
       "      <td>9.151222</td>\n",
       "      <td>10.383081</td>\n",
       "      <td>16.738329</td>\n",
       "      <td>10.816002</td>\n",
       "      <td>8.606503</td>\n",
       "      <td>8.685979</td>\n",
       "      <td>11.232705</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>19.997921</td>\n",
       "      <td>10.858885</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>6.273519</td>\n",
       "      <td>11.051758</td>\n",
       "      <td>14.601824</td>\n",
       "      <td>41.960819</td>\n",
       "      <td>16.255653</td>\n",
       "      <td>15.805614</td>\n",
       "      <td>6.086357</td>\n",
       "      <td>...</td>\n",
       "      <td>15.805391</td>\n",
       "      <td>10.632546</td>\n",
       "      <td>2.645518</td>\n",
       "      <td>12.581437</td>\n",
       "      <td>13.283297</td>\n",
       "      <td>13.978543</td>\n",
       "      <td>8.396217</td>\n",
       "      <td>10.486717</td>\n",
       "      <td>6.406193</td>\n",
       "      <td>9.602920</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>15.502339</td>\n",
       "      <td>6.203304</td>\n",
       "      <td>6.273519</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>9.506178</td>\n",
       "      <td>10.106242</td>\n",
       "      <td>37.715240</td>\n",
       "      <td>11.760073</td>\n",
       "      <td>11.310033</td>\n",
       "      <td>4.540777</td>\n",
       "      <td>...</td>\n",
       "      <td>11.309811</td>\n",
       "      <td>6.136965</td>\n",
       "      <td>7.119937</td>\n",
       "      <td>8.085856</td>\n",
       "      <td>8.787716</td>\n",
       "      <td>13.072963</td>\n",
       "      <td>7.150637</td>\n",
       "      <td>5.531137</td>\n",
       "      <td>5.020613</td>\n",
       "      <td>7.567339</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>20.190578</td>\n",
       "      <td>11.051542</td>\n",
       "      <td>10.141758</td>\n",
       "      <td>8.366178</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>14.794482</td>\n",
       "      <td>41.133480</td>\n",
       "      <td>16.448311</td>\n",
       "      <td>15.678271</td>\n",
       "      <td>7.159016</td>\n",
       "      <td>...</td>\n",
       "      <td>15.998051</td>\n",
       "      <td>10.825205</td>\n",
       "      <td>12.278176</td>\n",
       "      <td>12.774096</td>\n",
       "      <td>12.405954</td>\n",
       "      <td>15.361201</td>\n",
       "      <td>7.818875</td>\n",
       "      <td>9.999375</td>\n",
       "      <td>4.988852</td>\n",
       "      <td>8.575578</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>...</th>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "      <td>...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1253</th>\n",
       "      <td>26.107365</td>\n",
       "      <td>16.968328</td>\n",
       "      <td>13.988544</td>\n",
       "      <td>14.282963</td>\n",
       "      <td>14.861201</td>\n",
       "      <td>20.711267</td>\n",
       "      <td>47.690262</td>\n",
       "      <td>22.365097</td>\n",
       "      <td>21.915058</td>\n",
       "      <td>12.675801</td>\n",
       "      <td>...</td>\n",
       "      <td>21.914837</td>\n",
       "      <td>16.741991</td>\n",
       "      <td>13.424962</td>\n",
       "      <td>18.690882</td>\n",
       "      <td>19.232740</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>11.675661</td>\n",
       "      <td>16.596161</td>\n",
       "      <td>11.815638</td>\n",
       "      <td>14.892365</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1254</th>\n",
       "      <td>18.705038</td>\n",
       "      <td>9.566002</td>\n",
       "      <td>8.396217</td>\n",
       "      <td>6.880637</td>\n",
       "      <td>9.608875</td>\n",
       "      <td>13.308942</td>\n",
       "      <td>39.317940</td>\n",
       "      <td>14.962771</td>\n",
       "      <td>13.862731</td>\n",
       "      <td>4.503475</td>\n",
       "      <td>...</td>\n",
       "      <td>14.512510</td>\n",
       "      <td>9.339664</td>\n",
       "      <td>9.032636</td>\n",
       "      <td>11.288555</td>\n",
       "      <td>10.590414</td>\n",
       "      <td>11.675661</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>8.183835</td>\n",
       "      <td>3.173311</td>\n",
       "      <td>7.360038</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1255</th>\n",
       "      <td>16.365540</td>\n",
       "      <td>7.226502</td>\n",
       "      <td>9.786717</td>\n",
       "      <td>4.541137</td>\n",
       "      <td>10.339375</td>\n",
       "      <td>10.969441</td>\n",
       "      <td>36.278435</td>\n",
       "      <td>12.623271</td>\n",
       "      <td>10.293231</td>\n",
       "      <td>5.713975</td>\n",
       "      <td>...</td>\n",
       "      <td>12.173010</td>\n",
       "      <td>7.000164</td>\n",
       "      <td>10.853136</td>\n",
       "      <td>8.949056</td>\n",
       "      <td>7.350914</td>\n",
       "      <td>14.916162</td>\n",
       "      <td>7.613835</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>5.483811</td>\n",
       "      <td>8.510538</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1256</th>\n",
       "      <td>16.715014</td>\n",
       "      <td>7.575979</td>\n",
       "      <td>6.406193</td>\n",
       "      <td>4.890613</td>\n",
       "      <td>7.088852</td>\n",
       "      <td>11.318917</td>\n",
       "      <td>36.487911</td>\n",
       "      <td>12.972747</td>\n",
       "      <td>11.032707</td>\n",
       "      <td>2.513451</td>\n",
       "      <td>...</td>\n",
       "      <td>12.522487</td>\n",
       "      <td>7.349640</td>\n",
       "      <td>8.542612</td>\n",
       "      <td>9.298532</td>\n",
       "      <td>7.760390</td>\n",
       "      <td>12.485638</td>\n",
       "      <td>3.173311</td>\n",
       "      <td>5.353811</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>5.230014</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1257</th>\n",
       "      <td>19.041740</td>\n",
       "      <td>9.902705</td>\n",
       "      <td>10.982920</td>\n",
       "      <td>7.217339</td>\n",
       "      <td>8.495578</td>\n",
       "      <td>13.645644</td>\n",
       "      <td>39.314640</td>\n",
       "      <td>15.299474</td>\n",
       "      <td>14.849434</td>\n",
       "      <td>7.040178</td>\n",
       "      <td>...</td>\n",
       "      <td>14.849213</td>\n",
       "      <td>9.676366</td>\n",
       "      <td>13.119339</td>\n",
       "      <td>11.625257</td>\n",
       "      <td>12.327117</td>\n",
       "      <td>15.462364</td>\n",
       "      <td>7.890038</td>\n",
       "      <td>9.530538</td>\n",
       "      <td>5.060014</td>\n",
       "      <td>0.000000</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>1258 rows × 1258 columns</p>\n",
       "</div>"
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "execution_count": 5
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 2
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython2",
   "version": "2.7.6"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
